<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RetroVerse Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 20px;
      line-height: 1.5;
      color: #111;
      background: #e8e8e8;
      padding: 24px;
      max-width: 640px;
      margin: 0 auto;
    }
    h1 { font-size: 1.4rem; margin-bottom: 1rem; color: #000; }
    .status { font-size: 1.1rem; margin-bottom: 1rem; color: #333; }
    .status.error { color: #b00; font-weight: 600; }
    .banner {
      font-size: 1.1rem;
      padding: 12px 16px;
      margin-bottom: 1rem;
      background: #fff;
      border: 2px solid #222;
      border-radius: 6px;
    }
    .banner strong { margin-right: 0.4rem; }
    .video-card {
      background: #fff;
      border: 2px solid #222;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
    }
    .video-card .title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.4rem; }
    .video-card .meta { font-size: 1.1rem; color: #333; margin-bottom: 0.2rem; }
    .video-card .path { font-size: 0.95rem; color: #555; word-break: break-all; }
    .candidates-section { margin-top: 1.25rem; }
    .candidates-section h2 { font-size: 1.15rem; margin-bottom: 0.5rem; }
    .search-box {
      width: 100%;
      font-size: 1.1rem;
      padding: 12px 14px;
      border: 2px solid #222;
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    .search-box:focus { outline: 2px solid #0066cc; outline-offset: 2px; }
    .candidate-list { list-style: none; }
    .candidate-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #ccc;
    }
    .candidate-item:last-child { border-bottom: none; }
    .candidate-item input[type="radio"] {
      width: 24px;
      height: 24px;
      margin-top: 2px;
      cursor: pointer;
    }
    .candidate-item label { cursor: pointer; flex: 1; font-size: 1.05rem; }
    .candidate-confidence { font-size: 1.05rem; font-weight: 600; color: #0066cc; min-width: 4rem; text-align: right; }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 1.5rem;
    }
    .actions button {
      font-size: 1.05rem;
      padding: 14px 22px;
      border: 2px solid #222;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      min-width: 160px;
    }
    .actions button:focus { outline: 2px solid #0066cc; outline-offset: 2px; }
    .btn-accept { background: #0a6b0a; color: #fff; border-color: #0a6b0a; }
    .btn-not-billboard { background: #c00; color: #fff; border-color: #c00; }
    .btn-skip { background: #fff; color: #222; }
    .btn-save { background: #0066cc; color: #fff; border-color: #0066cc; }
    .btn-accept:disabled, .btn-not-billboard:disabled, .btn-skip:disabled { opacity: 0.6; cursor: not-allowed; }
    .empty-state { padding: 2rem; text-align: center; color: #444; font-size: 1.15rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>RetroVerse Editor</h1>
  <p class="status" id="status">Loading…</p>
  <div id="banner" class="banner hidden" aria-live="polite"></div>

  <div id="main" class="hidden">
    <div class="video-card">
      <p class="title" id="video-title">—</p>
      <p class="meta" id="video-artist">—</p>
      <p class="meta" id="video-year">—</p>
      <p class="path" id="video-path">—</p>
    </div>

    <div class="candidates-section">
      <h2>Top 5 Billboard candidates</h2>
      <input type="text" class="search-box" id="candidate-search" placeholder="Search candidates…" aria-label="Search candidates">
      <ul class="candidate-list" id="candidate-list"></ul>
    </div>

    <div class="actions">
      <button type="button" class="btn-accept" id="btn-accept">Accept match</button>
      <button type="button" class="btn-not-billboard" id="btn-not-billboard">Not Billboard</button>
      <button type="button" class="btn-skip" id="btn-skip">Skip</button>
      <button type="button" class="btn-save" id="btn-save">Save</button>
    </div>
  </div>

  <div id="empty" class="hidden empty-state">
    No more videos to review. Click Save to download your decisions.
  </div>

  <script>
    (function () {
      var statusEl = document.getElementById('status');
      var bannerEl = document.getElementById('banner');
      var mainEl = document.getElementById('main');
      var emptyEl = document.getElementById('empty');
      var videoTitleEl = document.getElementById('video-title');
      var videoArtistEl = document.getElementById('video-artist');
      var videoYearEl = document.getElementById('video-year');
      var videoPathEl = document.getElementById('video-path');
      var candidateListEl = document.getElementById('candidate-list');
      var candidateSearchEl = document.getElementById('candidate-search');
      var btnAccept = document.getElementById('btn-accept');
      var btnNotBillboard = document.getElementById('btn-not-billboard');
      var btnSkip = document.getElementById('btn-skip');
      var btnSave = document.getElementById('btn-save');

      var videoIndex = [];
      var decisions = {};
      var currentIndex = 0;

      function setStatus(msg, isError) {
        statusEl.textContent = msg;
        statusEl.className = 'status' + (isError ? ' error' : '');
      }

      function updateBanner() {
        var total = videoIndex.length;
        var reviewed = Object.keys(decisions).length;
        var remaining = total - reviewed;
        if (total === 0) {
          bannerEl.classList.add('hidden');
          return;
        }
        bannerEl.classList.remove('hidden');
        bannerEl.innerHTML = '<strong>Total:</strong> ' + total + ' &nbsp; <strong>Reviewed:</strong> ' + reviewed + ' &nbsp; <strong>Remaining:</strong> ' + remaining;
      }

      function normalizeIndex(data) {
        if (data == null) return [];
        if (Array.isArray(data)) return data;
        if (typeof data === 'object') return Object.values(data);
        return [];
      }

      function videoId(v) {
        return v.video_id != null ? v.video_id : (v.videoId || v.song_id || v.id);
      }

      function getUnmatched() {
        return videoIndex.filter(function (v) {
          var id = videoId(v);
          return id != null && !decisions[id];
        });
      }

      function getCurrent() {
        var list = getUnmatched();
        if (currentIndex >= list.length) return null;
        return list[currentIndex];
      }

      function getTop5(video) {
        var raw = video.candidates || video.matches || [];
        var list = raw.map(function (c) {
          return {
            billboard_id: c.billboard_id != null ? c.billboard_id : (c.billboard_song_id || c.id || ''),
            artist: c.artist != null ? c.artist : (c.video_artist || ''),
            title: c.title != null ? c.title : (c.video_title || ''),
            year: c.year != null ? c.year : (c.video_year != null ? c.video_year : (c.primary_year || '')),
            confidence: typeof c.confidence === 'number' ? c.confidence : (parseFloat(c.match_score || c.confidence_pct / 100) || 0)
          };
        });
        list.sort(function (a, b) {
          var c = (b.confidence || 0) - (a.confidence || 0);
          if (c !== 0) return c;
          var sa = [a.artist, a.title, a.year].join('\t');
          var sb = [b.artist, b.title, b.year].join('\t');
          return sa.localeCompare(sb);
        });
        return list.slice(0, 5);
      }

      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function escapeAttr(s) {
        return String(s).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function renderCandidates(video, searchTerm) {
        var candidates = getTop5(video);
        var term = (searchTerm || '').toLowerCase().trim();
        var filtered = term
          ? candidates.filter(function (c) {
              var s = [c.artist, c.title, c.year].join(' ').toLowerCase();
              return s.indexOf(term) !== -1;
            })
          : candidates;

        candidateListEl.innerHTML = filtered.map(function (c, i) {
          var pct = Math.round((c.confidence || 0) * 100);
          return (
            '<li class="candidate-item">' +
            '<input type="radio" name="candidate" id="cand-' + i + '" value="' + i + '" data-billboard-id="' + escapeAttr(c.billboard_id) + '" data-confidence="' + c.confidence + '">' +
            '<label for="cand-' + i + '">' +
            escapeHtml(c.artist || '—') + ' — ' + escapeHtml(c.title || '') +
            (c.year ? ' — ' + escapeHtml(String(c.year)) : '') +
            '</label>' +
            '<span class="candidate-confidence">' + pct + '%</span>' +
            '</li>'
          );
        }).join('');

        [].forEach.call(document.querySelectorAll('#candidate-list input[name="candidate"]'), function (radio) {
          radio.addEventListener('change', function () { btnAccept.disabled = false; });
        });
      }

      function showVideo(video) {
        videoTitleEl.textContent = video.title != null ? video.title : '—';
        videoArtistEl.textContent = video.artist != null ? video.artist : '—';
        videoYearEl.textContent = video.year != null ? String(video.year) : '—';
        videoPathEl.textContent = video.file_path != null ? video.file_path : (video.filePath || '—');
        renderCandidates(video, candidateSearchEl.value);
        btnAccept.disabled = true;
        mainEl.classList.remove('hidden');
        emptyEl.classList.add('hidden');
        updateBanner();
      }

      function showEmpty() {
        mainEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        updateBanner();
      }

      function advance() {
        var list = getUnmatched();
        if (currentIndex >= list.length) {
          showEmpty();
          return;
        }
        showVideo(list[currentIndex]);
      }

      function recordDecision(decision, billboardId, confidence) {
        var video = getCurrent();
        if (!video) return;
        var id = videoId(video);
        decisions[id] = {
          decision: decision,
          billboard_id: billboardId || undefined,
          confidence: typeof confidence === 'number' ? confidence : undefined,
          timestamp: new Date().toISOString()
        };
        currentIndex++;
        advance();
      }

      btnAccept.addEventListener('click', function () {
        var sel = document.querySelector('#candidate-list input[name="candidate"]:checked');
        if (!sel) return;
        recordDecision('accept', sel.dataset.billboardId || '', parseFloat(sel.dataset.confidence) || 0);
      });

      btnNotBillboard.addEventListener('click', function () {
        recordDecision('not_billboard');
      });

      btnSkip.addEventListener('click', function () {
        recordDecision('skip');
      });

      btnSave.addEventListener('click', function () {
        var blob = new Blob([JSON.stringify(decisions, null, 2)], { type: 'application/json' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'decisions.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      candidateSearchEl.addEventListener('input', function () {
        var video = getCurrent();
        if (video) renderCandidates(video, candidateSearchEl.value);
      });

      var indexUrl = 'data/video-index.json';
      var decisionsUrl = 'data/decisions.json';

      fetch(indexUrl)
        .then(function (r) {
          if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
          return r.json();
        })
        .then(function (data) {
          videoIndex = normalizeIndex(data) || [];
          setStatus('');
          return fetch(decisionsUrl).then(function (r) {
            if (r.ok) return r.json();
            return {};
          }).catch(function () { return {}; });
        })
        .then(function (decisionsData) {
          if (decisionsData && typeof decisionsData === 'object' && !Array.isArray(decisionsData)) {
            decisions = decisionsData;
          } else {
            decisions = decisions || {};
          }
          updateBanner();
          advance();
        })
        .catch(function (err) {
          setStatus('Could not load video-index.json. Use a local server or deploy to Netlify. ' + err.message, true);
        });
    })();
  </script>
</body>
</html>
